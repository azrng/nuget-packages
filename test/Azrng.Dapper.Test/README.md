# Common.Dapper 单元测试

本项目是 Common.Dapper 库的单元测试项目，使用 xUnit 作为测试框架。

## 测试覆盖

本测试项目包含以下测试类：

| 测试类 | 功能 | 测试数量 |
|--------|------|---------|
| `QueryTests` | 查询功能测试（同步/异步） | 4 |
| `ExecuteTests` | 执行功能测试（增删改） | 4 |
| `BatchTests` | 批量操作测试 | 2 |
| `ScalarTests` | 标量查询测试 | 3 |
| `PagedQueryTests` | 分页查询测试 | 2 |
| `MultipleResultTests` | 多结果集查询测试 | 2 |
| `TransactionTests` | 事务操作测试 | 6 |

**总计：23 个测试用例**

## 环境准备

### 1. 安装 PostgreSQL

确保已安装 PostgreSQL 数据库（推荐版本 12+）

### 2. 创建数据库

```sql
CREATE DATABASE test;
```

### 3. 执行数据库脚本

运行 [DatabaseSetup.sql](DatabaseSetup.sql) 脚本创建必要的表结构：

```bash
psql -U postgres -d test -f DatabaseSetup.sql
```

或在 pgAdmin 中直接执行该脚本。

### 4. 配置数据库连接

修改 [Startup.cs](Startup.cs) 中的数据库连接字符串：

```csharp
var pgsqlConn = "Host=localhost;Username=postgres;Password=your_password;Database=test;port=5432";
```

## 运行测试

### 通过 Visual Studio

1. 打开"测试资源管理器"
2. 点击"运行所有测试"

### 通过 .NET CLI

```bash
# 运行所有测试
dotnet test

# 运行特定测试类
dotnet test --filter "FullyQualifiedName~QueryTests"

# 运行特定测试方法
dotnet test --filter "FullyQualifiedName~TestQueryAsync"

# 输出详细日志
dotnet test --logger "console;verbosity=detailed"
```

## 数据库表结构

### user 表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | bigint | 主键 | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY |
| account | varchar(20) | 账号 | NOT NULL |
| pass_word | varchar(20) | 密码 | NOT NULL |
| name | text | 姓名 | NOT NULL |
| sex | integer | 性别 | NOT NULL |
| credit | double precision | 积分 | NOT NULL |
| group_id | bigint | 组ID | NOT NULL |
| creater | varchar(50) | 创建人 | NOT NULL, DEFAULT '' |
| create_time | timestamp | 创建时间 | NOT NULL |
| modifyer | varchar(50) | 修改人 | NOT NULL, DEFAULT '' |
| modify_time | timestamp | 修改时间 | NOT NULL |
| deleted | boolean | 是否删除 | NOT NULL |
| disabled | boolean | 是否禁用 | NOT NULL |

## 清理测试数据

测试过程中会产生一些临时数据，可以通过以下 SQL 清理：

```sql
-- 清理测试产生的临时数据
DELETE FROM example."user"
WHERE account LIKE 'test_%'
   OR account LIKE 'batch%'
   OR account LIKE 'syncbatch%'
   OR account LIKE 'trans_%'
   OR account LIKE 'insert_%';
```

## 项目依赖

- **xUnit** - 测试框架
- **Xunit.DependencyInjection** - 依赖注入支持
- **Npgsql** - PostgreSQL 数据库驱动
- **Common.Dapper** - 被测试的项目

## 注意事项

1. 确保数据库服务正在运行
2. 测试会向数据库插入、更新、删除数据，建议使用独立的测试数据库
3. 大部分测试方法会在执行后自动清理产生的数据
4. 事务测试包含正常提交和异常回滚的验证

## 测试数据清理脚本

如需完全重置测试环境：

```sql
-- 删除所有数据
TRUNCATE TABLE example."user" RESTART IDENTITY CASCADE;

-- 重新插入初始测试数据
INSERT INTO example."user"
    (account, pass_word, name, sex, credit, group_id, creater, create_time, modifyer, modify_time, deleted, disabled)
VALUES
    ('admin', 'admin123', '系统管理员', 1, 1000.0, 1, 'system', NOW(), 'system', NOW(), false, false),
    ('user001', 'pass123', '测试用户1', 1, 100.0, 1, 'system', NOW(), 'system', NOW(), false, false),
    ('user002', 'pass123', '测试用户2', 0, 200.0, 2, 'system', NOW(), 'system', NOW(), false, false),
    ('user003', 'pass123', '测试用户3', 1, 150.0, 1, 'system', NOW(), 'system', NOW(), false, false),
    ('user004', 'pass123', '测试用户4', 0, 300.0, 2, 'system', NOW(), 'system', NOW(), false, false),
    ('deleted_user', 'pass123', '已删除用户', 1, 50.0, 1, 'system', NOW(), 'system', NOW(), true, false);
```
